# FlexyFace: RealVisXL Parameter Sweep - Planning & Status Document

**Date:** 2025-11-27 08:15 UTC
**Status:** Generation COMPLETE, GPU Scoring PENDING

---

## Project Overview (For New Conversations)

**FlexyFace** is a FastAPI-based image generation benchmark application that:
- Generates images using multiple AI models (FLUX.1-schnell, RealVisXL, SD3, HiDream, FLUX.2-dev)
- Scores image quality with ML metrics (CLIP alignment, aesthetic scores)
- Runs in Docker with PostgreSQL database
- Has a React frontend for interactive benchmarking ("Nerd Sandbox")

**Key directories:**
- `/home/halsted/Python/flexy-face/` - Main project
- `/home/halsted/Python/flexy-face/backend/` - FastAPI backend
- `/home/halsted/Python/flexy-face/scripts/` - Data collection & scoring scripts
- `/tmp/metrics_models/` - Downloaded model weights

---

## Current Task: RealVisXL Parameter Sweep

### Goal
Generate **2000 images** with RealVisXL at randomized parameters, score each with **4 quality metrics**, and export CSV for ML analysis of optimal generation settings.

### Parameter Ranges
| Parameter | Range | Default |
|-----------|-------|---------|
| Steps | 4-60 | 8-48 |
| Guidance | 0.5-12.0 | 1.0-8.0 |
| Resolution | 512x512 | - |
| TF32 | Enabled | - |

### 4 Scoring Metrics
| Metric | Column | Model | Purpose |
|--------|--------|-------|---------|
| CLIP Score | `clip_score` | CLIP ViT-L/14 | Text-image alignment (0-1) |
| Aesthetic V1 | `aesthetic_score` | LAION MLP | Beauty rating (1-10) |
| Aesthetic V2 | `aes_v2_score` | `shunk031/aesthetics-predictor-v2-sac-logos-ava1-l14-linearMSE` | Refined beauty |
| HPS v2.1 | `hps_v2_score` | Human Preference Score | Human preference |

---

## Current Status

### Database Counts (as of 2025-11-27 08:15)
```
Total images: 2000 âœ“
CLIP scores:  1865 (135 being scored by CPU phase)
Aesthetic V1: 1865
Aesthetic V2: 0 (pending GPU scoring)
HPS v2:       0 (pending GPU scoring)
```

### Generation History
1. **Run 1:** 600 images (initial sweep)
2. **Run 2:** 400 images (expanded)
3. **Run 3:** 143 images (to reach 1143)
4. **Run 4:** 857 images (just completed - Run ID: `4b7193fd-ae99-42d2-a3f0-dfaf1d9056f4`)

---

## Scripts Created

### 1. Data Collection Script
**File:** `scripts/data_collection_spy.py`

Generates images with RealVisXL and scores with CLIP + Aesthetic V1 on CPU.

```bash
# To run (with backend stopped):
docker compose stop backend
DATABASE_URL="postgresql://flexyface:flexypass@localhost:7432/flexyface" \
python3 scripts/data_collection_spy.py
```

**Key config (line 48):**
```python
TARGET_IMAGES = 857  # Adjust as needed
```

### 2. GPU Scoring Script (All 4 Metrics)
**File:** `scripts/score_all_gpu.py`

Scores all images with 4 models sequentially on GPU. Loads one model at a time, scores all images, clears VRAM, moves to next.

```bash
# To run (with backend stopped):
docker compose stop backend
DATABASE_URL="postgresql://flexyface:flexypass@localhost:7432/flexyface" \
python3 scripts/score_all_gpu.py
```

**Models scored in order:**
1. CLIP + Aesthetic V1 (shares CLIP encoder)
2. Aesthetic V2
3. HPS v2.1

### 3. Extended Metrics Script (Aesthetic V2 + HPS v2 only)
**File:** `scripts/score_extended_metrics.py`

Lighter script for just the two new metrics (if CLIP/Aes V1 already done).

---

## Database Schema

**Table:** `bench_run_results`

```sql
-- Relevant columns:
id              UUID PRIMARY KEY
run_id          UUID  -- Links to bench_runs
engine          VARCHAR(50)  -- 'realvis_xl'
steps           INTEGER
guidance        FLOAT
seed            INTEGER
elapsed_ms      INTEGER
image_path      TEXT
clip_score      FLOAT  -- 0-1 range
aesthetic_score FLOAT  -- 1-10 range
aes_v2_score    FLOAT  -- Added for this sweep
hps_v2_score    FLOAT  -- Added for this sweep
created_at      TIMESTAMP
```

**Migration applied:**
```sql
ALTER TABLE bench_run_results ADD COLUMN aes_v2_score FLOAT;
ALTER TABLE bench_run_results ADD COLUMN hps_v2_score FLOAT;
```

---

## Next Steps

### IMMEDIATE: Run GPU Scoring
```bash
# 1. Ensure backend is stopped (frees GPU)
docker compose stop backend

# 2. Run GPU scoring for all 4 metrics
DATABASE_URL="postgresql://flexyface:flexypass@localhost:7432/flexyface" \
HPS_ROOT=/tmp/metrics_models/hpsv2 \
python3 scripts/score_all_gpu.py
```

**Expected time:** ~5-10 minutes for 2000 images on GPU

### THEN: Export CSV
```bash
docker exec flexy-face-db-1 psql -U flexyface -d flexyface \
  -c "COPY (
    SELECT steps, guidance, clip_score, aesthetic_score, aes_v2_score, hps_v2_score, elapsed_ms, seed
    FROM bench_run_results
    WHERE clip_score IS NOT NULL
      AND aesthetic_score IS NOT NULL
      AND aes_v2_score IS NOT NULL
      AND hps_v2_score IS NOT NULL
    ORDER BY steps, guidance
  ) TO STDOUT WITH CSV HEADER" > sweep_4metrics_2000.csv
```

### FINALLY: ML Analysis
Use the CSV to analyze:
- Optimal steps for quality vs speed tradeoff
- Guidance scale impact on each metric
- Correlation between metrics
- Identify sweet spots

---

## Dependencies Installed

```bash
pip install simple-aesthetics-predictor hpsv2
```

**Note:** HPS v2 requires `HPS_ROOT` env var:
```bash
export HPS_ROOT=/tmp/metrics_models/hpsv2
```

---

## Troubleshooting

### Aesthetic V2 Model 401/404 Error
- Fixed by using correct HuggingFace model ID
- Model: `shunk031/aesthetics-predictor-v2-sac-logos-ava1-l14-linearMSE`

### HPS v2 BPE Vocab Missing
- Fixed by setting `HPS_ROOT` environment variable
- Downloads automatically on first run

### VRAM Issues
- Scripts clear VRAM between models using:
```python
gc.collect()
torch.cuda.empty_cache()
torch.cuda.synchronize()
```

---

## Quick Reference Commands

```bash
# Check database status
docker exec flexy-face-db-1 psql -U flexyface -d flexyface \
  -c "SELECT COUNT(*) as total, COUNT(clip_score) as clip, COUNT(aesthetic_score) as aes_v1, COUNT(aes_v2_score) as aes_v2, COUNT(hps_v2_score) as hps_v2 FROM bench_run_results;"

# View sample results
docker exec flexy-face-db-1 psql -U flexyface -d flexyface \
  -c "SELECT steps, guidance, clip_score, aesthetic_score FROM bench_run_results ORDER BY created_at DESC LIMIT 5;"

# Count images per parameter range
docker exec flexy-face-db-1 psql -U flexyface -d flexyface \
  -c "SELECT steps/10*10 as step_bucket, COUNT(*) FROM bench_run_results GROUP BY step_bucket ORDER BY step_bucket;"

# Start backend after scoring
docker compose up -d backend
```

---

## Files Modified in This Session

1. `scripts/data_collection_spy.py` - Set TARGET_IMAGES=857
2. `scripts/score_all_gpu.py` - **CREATED** - GPU scoring for all 4 metrics
3. `backend/app/models.py` - Added `aes_v2_score`, `hps_v2_score` columns
4. `.claude/plans/glistening-watching-codd.md` - Planning document

---

## Conversation Starters for Claude

To continue this work in a new conversation, tell Claude:

> "I'm working on the FlexyFace RealVisXL parameter sweep. I have 2000 images generated. I need to run GPU scoring with `scripts/score_all_gpu.py` for Aesthetic V2 and HPS v2 metrics. Read `/home/halsted/Python/flexy-face/docs/3_PLANNING_2025-11-27_0815.md` for full context."

Or for analysis:

> "I have a CSV of 2000 RealVisXL images with 4 quality metrics (CLIP, Aesthetic V1, Aesthetic V2, HPS v2). Help me analyze optimal steps/guidance settings."
