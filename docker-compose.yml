services:
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-flexyface}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-flexypass}
      POSTGRES_DB: ${POSTGRES_DB:-flexyface}
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "7432:5432"

  backend:
    build: ./backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN:-}
      - HF_HUB_ENABLE_HF_TRANSFER=1
      - DATABASE_URL=${DATABASE_URL:-postgresql+psycopg2://flexyface:flexypass@db:5432/flexyface}
      - PRANK_IMAGE_ROOT=/data/prank_images
      - PRANK_LLM_ID=${PRANK_LLM_ID:-meta-llama/Meta-Llama-3-8B-Instruct}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - GPU_COORD_PATH=/gpu_coord/status.json
      - EXCLUDED_LIVE_MODELS=${EXCLUDED_LIVE_MODELS:-hidream_dev}
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - MAX_IMAGE_SIDE=1024
    volumes:
      - hf_cache:/root/.cache/huggingface
      - ./prank_images:/data/prank_images
      - ./backend/data:/app/data
      - gpu-coord:/gpu_coord
    ports:
      - "7999:7999"
    depends_on:
      - db
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  benchmark:
    build:
      context: .
      dockerfile: research/Dockerfile.benchmark
    env_file:
      - .env
    environment:
      - GPU_COORD_PATH=/gpu_coord/status.json
      - HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN:-}
      - HF_HUB_ENABLE_HF_TRANSFER=1
    volumes:
      - gpu-coord:/gpu_coord
      - hf_cache:/root/.cache/huggingface
      - ./research:/workspace/research:ro
      - ./research/benchmark_results:/workspace/benchmark_results
    command: ["python", "research/benchmarks/efficient_benchmark_runner.py", "--yes"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  hf_cache:
  db_data:
  gpu-coord:
